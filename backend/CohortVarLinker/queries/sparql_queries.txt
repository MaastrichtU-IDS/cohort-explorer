# Query to Retrieve Studies Metadata
PREFIX rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs:  <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd:   <http://www.w3.org/2001/XMLSchema#>
PREFIX dc:    <http://purl.org/dc/elements/1.1/>
PREFIX ro:    <http://purl.obolibrary.org/obo/ro.owl/>
PREFIX obi:   <http://purl.obolibrary.org/obo/obi.owl/>
PREFIX iao:   <http://purl.obolibrary.org/obo/iao.owl/>
PREFIX sio:   <http://semanticscience.org/ontology/sio.owl/>
PREFIX bfo:   <http://purl.obolibrary.org/obo/bfo.owl/>
PREFIX ncbi:  <http://purl.bioontology.org/ontology/NCBITAXON/>
PREFIX cmeo:  <https://w3id.org/CMEO/>

SELECT
  ?cohortId
  ?study_type
  (SAMPLE(?study_participants) AS ?study_participants)
  (SAMPLE(?study_objective) AS ?study_objective)
  (SAMPLE(?study_start) AS ?study_start)
  (SAMPLE(?study_end) AS ?study_end)
  (SAMPLE(?study_ongoing) AS ?study_ongoing)
  (SAMPLE(?cohortInstitution) AS ?cohortInstitution)
  (SAMPLE(?administrator) AS ?administrator)
  (SAMPLE(?administrator_email) AS ?administrator_email)
  (SAMPLE(?study_contact_person) AS ?study_contact_person)
  (SAMPLE(?study_contact_person_email) AS ?study_contact_person_email)
  (SAMPLE(?population_location) AS ?population_location)
  (SAMPLE(?language) AS ?language)
	(SAMPLE(?duration) AS ?duration) 
  (SAMPLE(?data_collection_frequency) AS ?data_collection_frequency)   # ⟵ NEW
  (SAMPLE(?interventions) AS ?interventions)
  (SAMPLE(?inclusion_labels)   AS ?inclusion_labels)   # ⟵ NEW
  (SAMPLE(?inclusion_values)   AS ?inclusion_values)   # ⟵ NEW
  (SAMPLE(?exclusion_labels)   AS ?exclusion_labels)   # ⟵ NEW
  (SAMPLE(?exclusion_values)   AS ?exclusion_values)   # ⟵ NEW
  (SAMPLE(?variable_uris) AS ?variable_uris)  # ⟵ NEW
  (SAMPLE(?primary_outcome_spec) AS ?primary_outcome_spec)   # ⟵ NEW
  (SAMPLE(?secondary_outcome_spec) AS ?secondary_outcome_spec)   # ⟵ NEW
  (SAMPLE(?morbidity) AS ?morbidity)
WHERE {
  GRAPH <https://w3id.org/CMEO/graph/studies_metadata> {

    # --- Core study & protocol (keeps the rest anchored) ---
    ?study dc:identifier ?cohortId ;
           iao:is_about    ?descriptor ;
           ro:has_part   ?protocol .
    ?descriptor a sio:descriptor;
           rdfs:label ?study_type.
    ?protocol a obi:protocol .

    

    # --- Participants ---
       OPTIONAL {
      ?protocol ro:has_part ?participants_spec .
      ?participants_spec a cmeo:number_of_participants ;
                         cmeo:has_value ?study_participants .
    }
    
        # --- Objective ---
    OPTIONAL {
      ?protocol ro:has_part ?objective_spec .
      ?objective_spec a obi:objective_specification ;
                      cmeo:has_value ?study_objective .
    }
    
     OPTIONAL 
    { 
      		?protocol ro:has_part ?dcfrequency . 
      		?dcfrequency a cmeo:timeline_specification ; 
                  cmeo:has_value ?data_collection_frequency . 
    
    }
   
    OPTIONAL { 
      ?protocol ro:has_part ?intervention_spec.
      ?intervention_spec a cmeo:intervention_specification ; cmeo:has_value ?interventions . 
    
    }
    

    # --- Study execution / time / language / status / organization ---
 OPTIONAL {
       ?sde a obi:study_design_execution ;
                   ro:concretizes ?study;                                          
                  dc:language ?language .
      OPTIONAL {
       ?durationclass a cmeo:duration_of_observation ;
                            iao:is_about ?sde;
                            cmeo:has_value ?duration .
      }
      OPTIONAL {
         
         ?sde iao:has_time_stamp ?start_time.
         ?start_time a cmeo:start_time ; 
               cmeo:has_value ?study_start .
      }
      OPTIONAL {

          ?sde iao:has_time_stamp ?end_time.
          ?end_time   a cmeo:end_time;
             cmeo:has_value ?study_end .
      }
      OPTIONAL {
      
        ?completion_status a sio:ongoing ;
                     iao:is_about ?sde ;
                      cmeo:has_value ?study_ongoing .
      }

      
          
   OPTIONAL {
         ?sde ro:has_participant ?organization.
         
           ?organization a obi:organization ; 
                               cmeo:has_value ?cohortInstitution .
			OPTIONAL {
           ?admin a ncbi:homo_sapiens ;
                               obi:member_of ?organization;
          						cmeo:has_value ?administrator.

          OPTIONAL {
           ?admin_email a obi:email_address ;
                               iao:is_about ?admin ;
                               cmeo:has_value ?administrator_email .
          }
			
        }
        OPTIONAL {
           ?contactperson a ncbi:homo_sapiens ;
                               obi:member_of ?organization;
                               cmeo:has_value ?study_contact_person.
           ?contact_person_email a obi:email_address ;
                               iao:is_about ?contactperson ;
                               cmeo:has_value ?study_contact_person_email .
        }
        
      }
    }
  

    
  
       # --- PRIMARY outcomes (pre-aggregated) ---
    OPTIONAL {
      {
        SELECT ?study (GROUP_CONCAT(DISTINCT ?v; separator="||") AS ?primary_outcome_spec)
        WHERE {
          GRAPH <https://w3id.org/CMEO/graph/studies_metadata> {
            ?study ro:has_part ?p .
            ?p a obi:protocol ;
               ro:has_part ?outcome_spec .
            ?outcome_spec a cmeo:outcome_specification ;
                          ro:has_part ?prim_spec .
            ?prim_spec a cmeo:primary_outcome_specification ;
                       cmeo:has_value ?raw .
            BIND(STR(?raw) AS ?v)
          }
        }
        GROUP BY ?study
      }
    }

    # --- SECONDARY outcomes (pre-aggregated) ---
    OPTIONAL {
      {
        SELECT ?study (GROUP_CONCAT(DISTINCT ?v; separator="||") AS ?secondary_outcome_spec)
        WHERE {
          GRAPH <https://w3id.org/CMEO/graph/studies_metadata> {
            ?study ro:has_part ?p .
            ?p a obi:protocol ;
               ro:has_part ?outcome_spec .
            ?outcome_spec a cmeo:outcome_specification ;
                          ro:has_part ?sec_spec .
            ?sec_spec a cmeo:secondary_outcome_specification ;
                      cmeo:has_value ?raw .
            BIND(STR(?raw) AS ?v)
          }
        }
        GROUP BY ?study
      }
    }
    
      # --- VARIABLES URI (pre-aggregated) ---
    OPTIONAL {
      {
        SELECT ?study (GROUP_CONCAT(DISTINCT ?v; separator="||") AS ?variable_uris)
        WHERE {
          GRAPH <https://w3id.org/CMEO/graph/studies_metadata> {
            ?study ro:has_part ?p .
            ?p a obi:protocol;
             ro:has_part ?variable_spec.
			OPTIONAL{
              
      			?variable_spec a cmeo:study_design_variable_specification ;
                     ro:has_part ?variable_uri .
    
        
            	BIND(STR(?variable_uri) AS ?v)
              
            }
          }
        }
        GROUP BY ?study 
      }
    }
    
   {
      SELECT ?study ?population_location
             (GROUP_CONCAT(?lbl; SEPARATOR=" || ") AS ?inclusion_labels)
             (GROUP_CONCAT(?val; SEPARATOR=" || ") AS ?inclusion_values)
      		 (GROUP_CONCAT(?ex_lbl; SEPARATOR=" || ") AS ?exclusion_labels)
             (GROUP_CONCAT(?ex_val; SEPARATOR=" || ") AS ?exclusion_values)
             (GROUP_CONCAT(DISTINCT ?m; separator="; ") AS ?morbidity)
      WHERE {
        # Order the rows by a stable key (?k) so labels and values line up positionally
        SELECT ?study ?k ?lbl ?val ?ex_lbl ?ex_val ?population_location ?m
        WHERE {
          GRAPH <https://w3id.org/CMEO/graph/studies_metadata> {
            ?study ro:has_part ?protocol .
            ?protocol a obi:protocol ;
                     ro:has_part ?selection_criterion .
            ?selection_criterion a obi:eligibility_criterion ;
                                 ro:has_part ?criterion .
			
            OPTIONAL{
                    ?selection_criterion ro:is_concretized_by ?enrollment .
                    ?enrollment a cmeo:human_subject_enrollment;
                                         ro:has_output ?output_population .
                    
                    ?site iao:is_about ?output_population ; 
                          cmeo:has_value ?population_location .
              
              		 ?morbidity_spec a obi:morbidity ;
                            ro:is_characteristic_of ?output_population ;
                            cmeo:has_value ?mv .
            		BIND(STR(?mv) AS ?m)
              
            }
            # criterion type (any subclass)
           OPTIONAL{ ?criterion a obi:inclusion_criterion;
                ro:has_part  ?inclusion_criterion_sub.
               

            # stable ordering key per inclusion node
            BIND(STR(?inclusion_criterion_sub) AS ?k)

            # human-friendly criterion label
            OPTIONAL { ?inclusion_criterion_sub rdfs:label ?inc_label . }
            BIND(
                STR(?inc_label)
               AS ?lbl
            )

            # derive value: literal on inclusion or its parts, or label of a value node
            OPTIONAL { ?inclusion_criterion_sub cmeo:has_value ?val_raw . }
            BIND(STR(?val_raw) AS ?val)

            # keep only rows that actually have a value
            FILTER(BOUND(?val) && ?val != "")
            }
            OPTIONAL{
            
            ?criterion a obi:exclusion_criterion;
                ro:has_part  ?exclusion_criterion_sub.
            
             BIND(STR(?exclusion_criterion_sub) AS ?exc_k)
            
             OPTIONAL { ?exclusion_criterion_sub rdfs:label ?exc_label . }
            BIND(
                STR(?exc_label)
               AS ?ex_lbl
            )
            
             OPTIONAL { ?exclusion_criterion_sub cmeo:has_value ?exc_val_raw . }
            BIND(STR(?exc_val_raw) AS ?ex_val)

            # keep only rows that actually have a value
            FILTER(BOUND(?ex_val) && ?ex_val != "")
            }

          }
        }
        ORDER BY ?study ?population_location ?k ?exc_k ?m
      }
      GROUP BY ?study  ?population_location
    }
  }
}
GROUP BY ?study ?cohortId ?study_type



Query 2: Cross Mapping 


          PREFIX rdf:   <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
          PREFIX rdfs:  <http://www.w3.org/2000/01/rdf-schema#>
          PREFIX xsd:   <http://www.w3.org/2001/XMLSchema#>
          PREFIX dc:    <http://purl.org/dc/elements/1.1/>
          PREFIX ro:    <http://purl.obolibrary.org/obo/ro.owl/>
          PREFIX obi:   <http://purl.obolibrary.org/obo/obi.owl/>
          PREFIX iao:   <http://purl.obolibrary.org/obo/iao.owl/>
          PREFIX bfo:   <http://purl.obolibrary.org/obo/bfo.owl/>
          PREFIX cmeo:  <https://w3id.org/CMEO/>

          SELECT
          ?omop_id ?code_label ?code_value ?val
          (GROUP_CONCAT(DISTINCT ?varNameA; SEPARATOR=", ") AS ?source)
          (GROUP_CONCAT(DISTINCT ?varNameB; SEPARATOR=", ") AS ?target)
          (GROUP_CONCAT(DISTINCT ?visitsA ; SEPARATOR=", ") AS ?source_visit)
          (GROUP_CONCAT(DISTINCT ?visitsB ; SEPARATOR=", ") AS ?target_visit)
          WHERE {{
          {{
              # ---------- TIME-CHF (source) ----------
              SELECT
              ?omop_id ?code_label ?code_value ?val
              (GROUP_CONCAT(DISTINCT ?var_nameA; SEPARATOR=", ") AS ?varNameA)
              (GROUP_CONCAT(DISTINCT ?pairA   ; SEPARATOR=", ") AS ?visitsA)
              ("{source}" AS ?source)
              WHERE {{
              GRAPH <{graph_repo}/{source}>  {{
                  # 1) Most selective: mapping from data element -> standardized code (rdf:_1) -> OMOP
                  ?stdProcessA a cmeo:data_standardization ;
                              obi:has_specified_output ?codeSetA ;
                              obi:has_specified_input  ?dataElementA .
                  ?codeSetA rdf:_1 ?codeNodeA .
                  ?codeNodeA a cmeo:code ;
                          cmeo:has_value ?code_value ;
                          rdfs:label     ?code_label ;
                          iao:denotes    ?omopClassA .
                  ?omopClassA a cmeo:omop_id ; cmeo:has_value ?omop_id .

                  # 2) Data element identity (single valued)
                  ?dataElementA a cmeo:data_element ; dc:identifier ?var_nameA .

                  # 3) Optional category value (kept single per DE; if multi, choose one deterministically)
                  OPTIONAL {{
                  ?catProcessA a cmeo:categorization_process ;
                              obi:has_specified_input  ?dataElementA ;
                              obi:has_specified_output ?catOutA .
                  ?catOutA cmeo:has_value ?val .
                  }}

                  # 4) Visits per data element — pre-aggregate to avoid fan-out
                  OPTIONAL {{
                  {{
                      SELECT ?dataElementA (GROUP_CONCAT(DISTINCT ?visitLblA; SEPARATOR="|") AS ?visitStrA)
                      WHERE {{
                      ?visitDatumA a cmeo:visit_measurement_datum ;
                                  iao:is_about ?dataElementA ;
                                  obi:is_specified_input_of ?vsProcA .
                      ?vsProcA obi:has_specified_output ?visitCodeA .
                      ?visitCodeA rdfs:label ?visitLblA .
                      }}
                      GROUP BY ?dataElementA
                  }}
                  }}

                  # 5) Make the (var || visits) pair once, not multiplicatively
                  BIND(COALESCE(?visitStrA, "") AS ?visA)
                  BIND(CONCAT(STR(?var_nameA), "||", ?visA) AS ?pairA)
              }}
              }}
              GROUP BY ?omop_id ?code_label ?code_value ?val
          }}
          UNION
          {{
              # ---------- GISSI-HF (target) ----------
              SELECT
              ?omop_id ?code_label ?code_value ?val
              (GROUP_CONCAT(DISTINCT ?var_nameB; SEPARATOR=", ") AS ?varNameB)
              (GROUP_CONCAT(DISTINCT ?pairB   ; SEPARATOR=", ") AS ?visitsB)
              ("{target}" AS ?target)
              WHERE   {{
              GRAPH <{graph_repo}/{target}> {{
                  ?stdProcessB a cmeo:data_standardization ;
                              obi:has_specified_output ?codeSetB ;
                              obi:has_specified_input  ?dataElementB .
                  ?codeSetB rdf:_1 ?codeNodeB .
                  ?codeNodeB a cmeo:code ;
                          cmeo:has_value ?code_value ;
                          rdfs:label     ?code_label ;
                          iao:denotes    ?omopClassB .
                  ?omopClassB a cmeo:omop_id ; cmeo:has_value ?omop_id .

                  ?dataElementB a cmeo:data_element ; dc:identifier ?var_nameB .

                  OPTIONAL {{
                  ?catProcessB a cmeo:categorization_process ;
                              obi:has_specified_input  ?dataElementB ;
                              obi:has_specified_output ?catOutB .
                  ?catOutB cmeo:has_value ?val .
                  }}

                  OPTIONAL {{
                  {{
                      SELECT ?dataElementB (GROUP_CONCAT(DISTINCT ?visitLblB; SEPARATOR="|") AS ?visitStrB)
                      WHERE {{
                      ?visitDatumB a cmeo:visit_measurement_datum ;
                                  iao:is_about ?dataElementB ;
                                  obi:is_specified_input_of ?vsProcB .
                      ?vsProcB obi:has_specified_output ?visitCodeB .
                      ?visitCodeB rdfs:label ?visitLblB .
                      }}
                      GROUP BY ?dataElementB
                  }}
                  }}

                  BIND(COALESCE(?visitStrB, "") AS ?visB)
                  BIND(CONCAT(STR(?var_nameB), "||", ?visB) AS ?pairB)
              }}
              }}
              GROUP BY ?omop_id ?code_label ?code_value ?val
          }}
          }}
          GROUP BY ?omop_id ?code_label ?code_value ?val
          ORDER BY ?omop_id
